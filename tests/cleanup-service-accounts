#!/usr/bin/env bash
set -euo pipefail

LOGS_DIR="./logs"
DRY_RUN=false
RUN_FILTER=""

while [[ $# -gt 0 ]]; do
  case $1 in
    --dry-run) DRY_RUN=true; shift ;;
    --run) RUN_FILTER="$2"; shift 2 ;;
    *) echo "Usage: $0 [--dry-run] [--run <run_id>]"; exit 1 ;;
  esac
done

WHERE="status = 'failed' AND create_sa_ms IS NOT NULL"
if [[ -n "$RUN_FILTER" ]]; then
  WHERE="$WHERE AND run_id = $RUN_FILTER"
fi

SAS=$(duckdb -noheader -csv -c "
  SELECT DISTINCT service_account
  FROM read_json_auto('${LOGS_DIR}/**/*.json', ignore_errors=true)
  WHERE $WHERE
  ORDER BY run_id DESC, service_account;
")

if [[ -z "$SAS" ]]; then
  echo "No failed service accounts found."
  exit 0
fi

COUNT=$(echo "$SAS" | wc -l | tr -d ' ')
echo "Found $COUNT failed service account(s) to clean up:"
echo "$SAS" | sed 's/^/  /'
echo ""

if [[ "$DRY_RUN" == true ]]; then
  echo "(dry run â€” no deletions)"
  exit 0
fi

DELETED=0
ERRORS=0
while IFS= read -r sa; do
  if md service-account delete "$sa" >/dev/null 2>&1; then
    echo "  deleted: $sa"
    ((DELETED++))
  else
    echo "  FAILED:  $sa"
    ((ERRORS++))
  fi
done <<< "$SAS"

echo ""
echo "Done. Deleted: $DELETED, Failed: $ERRORS"
